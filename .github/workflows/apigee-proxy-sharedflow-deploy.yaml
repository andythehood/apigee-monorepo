# This is a workflow to deploy all changed ApigeeX proxies from this monorepo

name: Deploy ApigeeX Proxy and Shared Flows

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
    paths:
      - 'apiproxies/**'
      - 'sharedflows/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'apiproxies/**'
      - 'sharedflows/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changed Proxies and Shared Flows
    # This job detects which proxies and shared flows have changed since the last commit
    runs-on: ubuntu-latest
    environment: dev

    outputs:
      changed_proxies: ${{ steps.set-proxies.outputs.matrix }}
      # deleted_proxies: ${{ steps.set-deleted-proxies.outputs.matrix }}
      changed_sharedflows: ${{ steps.set-sharedflows.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          echo "Detecting changed files..."
          echo "Event name: ${{ github.event_name }}"

          # Compare with the base commit (for PRs) or previous SHA (for push)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE=${{ github.event.pull_request.base.sha }}
          else
            BASE=${{ github.event.before }}
          fi

          CHANGED=$(git diff --name-only "$BASE" ${{ github.sha }} | xargs)

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # - name: Get deleted files
      #   id: deleted
      #   run: |
      #     echo "Detecting deleted files..."
      #     echo "Event name: ${{ github.event_name }}"

      #     # Compare with the base commit (for PRs) or previous SHA (for push)
      #     if [[ "${{ github.event_name }}" == "pull_request" ]]; then
      #       BASE=${{ github.event.pull_request.base.sha }}
      #     else
      #       BASE=${{ github.event.before }}
      #     fi

      #     DELETED=$(git diff --name-status "$BASE" ${{ github.sha }} \
      #       | grep '^D' \
      #       | grep '^D[[:space:]]*proxies/' \
      #       | awk '{print $2}' \
      #       | awk -F/ '{print $2}' \
      #       | sort -u)


      #     echo "Deleted folders: $DELETED"


      #     echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
      #     echo "$DELETED" >> $GITHUB_OUTPUT
      #     echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract changed API Proxy folders
        id: set-proxies
        run: |
          FILES="${{ steps.changed.outputs.changed_files }}"

          PROXIES=$(echo "$FILES" | tr ' ' '\n' | grep '^apiproxies/' | cut -d/ -f2 | sort -u | jq -R . | jq -s .)
          # echo "matrix=$PROXIES" >> $GITHUB_OUTPUT

          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$PROXIES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # - name: Extract deleted API Proxy folders
      #   id: set-deleted-proxies
      #   run: |
      #     FILES="${{ steps.changed.outputs.deleted_files }}"
      #     echo "Deleted files: $FILES"

      #     PROXIES=

      #     # PROXIES=$(echo "$FILES" | tr ' ' '\n' | grep '^apiproxies/' | cut -d/ -f2 | sort -u | jq -R . | jq -s .)
      #     # # echo "matrix=$PROXIES" >> $GITHUB_OUTPUT

      #     echo "matrix<<EOF" >> $GITHUB_OUTPUT
      #     echo "$PROXIES" >> $GITHUB_OUTPUT
      #     echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract changed Shared Flow folders
        id: set-sharedflows
        run: |
          FILES="${{ steps.changed.outputs.changed_files }}"

          SHAREDFLOWS=$(echo "$FILES" | tr ' ' '\n' | grep '^sharedflows/' | cut -d/ -f2 | sort -u | jq -R . | jq -s .)
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$SHAREDFLOWS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  deploy-proxies:
    name: Deploy Changed Proxies
    needs: detect-changes
    if: needs.detect-changes.outputs.changed_proxies != '[]'
    runs-on: ubuntu-latest
    environment: dev
    env:
      APIGEE_X_ORG: ${{ vars.APIGEE_X_ORG }}
      APIGEE_X_ENVS: "public private"
    strategy:
      matrix:
        proxy: ${{ fromJson(needs.detect-changes.outputs.changed_proxies) }}
    steps:

      - name: Select branch for environment
        id: select_branch
        run: |
          echo "branch=main" >> $GITHUB_OUTPUT
          # if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
          #   echo "branch=main" >> $GITHUB_OUTPUT
          # # elif [ "${{ github.event.inputs.environment }}" = "sit" ]; then
          # #   echo "branch=feature/sit" >> $GITHUB_OUTPUT
          # elif [ "${{ github.event.inputs.environment }}" = "prod" ]; then
          #   echo "branch=feature/prod" >> $GITHUB_OUTPUT
          # fi

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check if proxy folder exists
        id: check_folder
        run: |
          if [ -d "apiproxies/${{ matrix.proxy }}/apiproxy" ]; then
            echo "Proxy Folder exists"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Folder does not exist"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up gcloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.APIGEE_SA_KEY }}

      - name: Install Apigee CLI
        run: |
          curl -sLO https://github.com/apigee/apigeecli/releases/download/v2.13.0/apigeecli_v2.13.0_Linux_x86_64.zip
          unzip apigeecli_v2.13.0_Linux_x86_64.zip
          sudo mv apigeecli_v2.13.0_Linux_x86_64/apigeecli /usr/local/bin/
          
      - name: Install apigeelint
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          npm install -g apigeelint

      - name: Run apigeelint
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          # set maxWarnings to -1 to ignore warnings, otherwise set to a number to fail build if the number of warnings is exceeded
          apigeelint -s ./apiproxies/${{ matrix.proxy }}/apiproxy -f stylish --maxWarnings 10

      - name: Create API Proxy bundle
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          mkdir bundle
          cd apiproxies/${{ matrix.proxy }}
          zip -r ../../bundle/${{ matrix.proxy }}.zip apiproxy

      - name: Import ApigeeX Proxy
        if: steps.check_folder.outputs.exists == 'true'
        id: import
        run: |
          apigeecli apis import --default-token -o "$APIGEE_X_ORG"  --folder ./bundle
          REVISION=$(apigeecli apis get --default-token -o "$APIGEE_X_ORG" --name ${{ matrix.proxy }} | jq -r '.latestRevisionId')
          echo "revision=$REVISION" >> "$GITHUB_OUTPUT"

      - name: Deploy ApigeeX Proxy
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          echo "Deploying revision ${{ steps.import.outputs.revision }}"
          for APIGEE_X_ENV in $APIGEE_X_ENVS; do
            apigeecli apis deploy --default-token -o "$APIGEE_X_ORG" -e "$APIGEE_X_ENV" --name "${{ matrix.proxy }}" --rev ${{ steps.import.outputs.revision }} --ovr
          done

      - name: Output Deployment Info
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          echo "Deployed ${{ matrix.proxy }} to environments $APIGEE_X_ENVS in project $APIGEE_X_ORG from branch ${{ steps.select_branch.outputs.branch }}"

      - name: Undeploy Deleted Proxies
        if: steps.check_folder.outputs.exists == 'false'
        run: |
          set +e  # disable immediate exit on error
          echo "Proxy ${{ matrix.proxy }} does not exist. Undeploying from all Environments."
          ENVS=$(apigeecli environments list --default-token -o "$APIGEE_X_ORG"  | jq -r '. | join(" ")')
          for APIGEE_X_ENV in $ENVS; do
            OUTPUT=$(apigeecli apis undeploy --default-token -o "$APIGEE_X_ORG" -e "$APIGEE_X_ENV" --name "${{ matrix.proxy }}")
            STATUS=$?

            if [ "$STATUS" -eq 0 ]; then
              echo "✅ Success"
            # elif echo "$OUTPUT" | grep -q "already exists"; then
            #   echo "ℹ️ Already exists, treating as success"
            else
              echo "❌ Unexpected error"
              exit $STATUS
            fi
          done

      - name: Remove Deleted Proxies
        if: steps.check_folder.outputs.exists == 'false'
        run: |
          echo "Proxy ${{ matrix.proxy }} does not exist. Deleting from Organization."
          # TODO: Add logic to delete the proxy from the organization


  deploy-sharedflows:
    name: Deploy Changed Shared Flows
    needs: detect-changes
    if: needs.detect-changes.outputs.changed_sharedflows != '[]'
    runs-on: ubuntu-latest
    environment: dev
    env:
      APIGEE_X_ORG: ${{ vars.APIGEE_X_ORG }}
      APIGEE_X_ENVS: "public private"
    strategy:
      matrix:
        sharedflow: ${{ fromJson(needs.detect-changes.outputs.changed_sharedflows) }}
    steps:

      - name: Select branch for environment
        id: select_branch
        run: |
          echo "branch=main" >> $GITHUB_OUTPUT
          # if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
          #   echo "branch=main" >> $GITHUB_OUTPUT
          # # elif [ "${{ github.event.inputs.environment }}" = "sit" ]; then
          # #   echo "branch=feature/sit" >> $GITHUB_OUTPUT
          # elif [ "${{ github.event.inputs.environment }}" = "prod" ]; then
          #   echo "branch=feature/prod" >> $GITHUB_OUTPUT
          # fi

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check if sharedflow folder exists
        id: check_folder
        run: |
          if [ -d "sharedflows/${{ matrix.sharedflow }}/sharedflowbundle" ]; then
            echo "Sharedflow folder exists"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Folder does not exist"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up gcloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.APIGEE_SA_KEY }}

      - name: Install Apigee CLI
        run: |
          curl -sLO https://github.com/apigee/apigeecli/releases/download/v2.13.0/apigeecli_v2.13.0_Linux_x86_64.zip
          unzip apigeecli_v2.13.0_Linux_x86_64.zip
          sudo mv apigeecli_v2.13.0_Linux_x86_64/apigeecli /usr/local/bin/

      - name: Install apigeelint
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          npm install -g apigeelint

      - name: Run apigeelint
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          # set maxWarnings to -1 to ignore warnings, otherwise set to a number to fail build if the number of warnings is exceeded
          apigeelint -s ./sharedflows/${{ matrix.sharedflow }}/sharedflowbundle -f stylish --maxWarnings 10

      - name: Create SharedFlow bundle
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          mkdir bundle
          cd sharedflows/${{ matrix.sharedflow }}
          zip -r ../../bundle/${{ matrix.sharedflow }}.zip sharedflowbundle

      - name: Import ApigeeX Shared Flow
        if: steps.check_folder.outputs.exists == 'true'
        id: import
        run: |
          apigeecli sharedflows import --default-token -o "$APIGEE_X_ORG" --folder ./bundle
          REVISION=$(apigeecli sharedflows get --default-token -o "$APIGEE_X_ORG" --name ${{ matrix.sharedflow }} | jq -r '.latestRevisionId')
          echo "revision=$REVISION" >> "$GITHUB_OUTPUT"

      - name: Deploy ApigeeX Shared Flow
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          echo "Deploying revision ${{ steps.import.outputs.revision }}"
          for APIGEE_X_ENV in $APIGEE_X_ENVS; do
            apigeecli sharedflows deploy --default-token -o "$APIGEE_X_ORG" -e "$APIGEE_X_ENV" --name "${{ matrix.sharedflow }}" --rev ${{ steps.import.outputs.revision }} --ovr
          done

      - name: Output Deployment Info
        if: steps.check_folder.outputs.exists == 'true'
        run: |
          echo "Deployed ${{ matrix.sharedflow }} to environments $APIGEE_X_ENVS in project $APIGEE_X_ORG from branch ${{ steps.select_branch.outputs.branch }}"

      - name: Undeploy Deleted Sharedflows
        if: steps.check_folder.outputs.exists == 'false'
        run: |
          set +e  # disable immediate exit on error
          echo "Proxy ${{ matrix.sharedflow }} does not exist. Undeploying from all Environments."
          ENVS=$(apigeecli environments list --default-token -o "$APIGEE_X_ORG" | jq -r '. | join(" ")')
          for APIGEE_X_ENV in $ENVS; do
            OUTPUT=$(apigeecli sharedflows undeploy --default-token -o "$APIGEE_X_ORG" -e "$APIGEE_X_ENV" --name "${{ matrix.sharedflow }}")
            STATUS=$?

            if [ "$STATUS" -eq 0 ]; then
              echo "✅ Success"
            # elif echo "$OUTPUT" | grep -q "already exists"; then
            #   echo "ℹ️ Already exists, treating as success"
            else
              echo "❌ Unexpected error"
              exit $STATUS
            fi
          done

      - name: Remove Deleted Sharedflows
        if: steps.check_folder.outputs.exists == 'false'
        run: |
          echo "Sharedflow ${{ matrix.sharedflow }} does not exist. Deleting from Organization."
          # TODO: Add logic to delete the sharedflow from the organization
